<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <meta name="msapplication-navbutton-color" content="#667eea">
    <meta name="apple-mobile-web-app-title" content="Êï∞ÊçÆÁÆ°ÁêÜÂô®">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiBmaWxsPSIjNjY3ZWVhIiByeD0iMjAiLz4KPHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgeD0iMzAiIHk9IjMwIiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0yMCAyMGg4MHY4MEgyMHoiIGZpbGw9Im5vbmUiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iNCIvPgo8Y2lyY2xlIGN4PSI2MCIgY3k9IjQwIiByPSI4IiBmaWxsPSJ3aGl0ZSIvPgo8Y2lyY2xlIGN4PSI2MCIgY3k9IjYwIiByPSI4IiBmaWxsPSJ3aGl0ZSIvPgo8Y2lyY2xlIGN4PSI2MCIgY3k9IjgwIiByPSI4IiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4KPC9zdmc+">
    <title>ÊâãÊú∫Á´ØÊï∞ÊçÆÁÆ°ÁêÜÂô®</title>
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            color: #333;
            /* Prevent pull-to-refresh and overscroll */
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            /* Prevent selection and context menus */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            /* Support for notch devices */
            padding-left: max(15px, env(safe-area-inset-left));
            padding-right: max(15px, env(safe-area-inset-right));
            padding-top: max(15px, env(safe-area-inset-top));
            padding-bottom: max(15px, env(safe-area-inset-bottom));
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 15px;
            text-align: center;
            position: relative;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0;
        }

        .table-selector {
            flex: 1;
            margin-right: 10px;
        }

        .table-selector select {
            width: 100%;
            padding: 6px 10px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 16px;
            font-size: 13px;
            outline: none;
        }

        .table-selector select option {
            background: #333;
            color: white;
        }

        .header-buttons {
            display: flex;
            gap: 6px;
        }

        .add-table-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 50%;
            width: 42px;
            height: 42px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }

        .add-table-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }

        .add-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 50%;
            width: 42px;
            height: 42px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }

        .add-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }

        .immersive-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 50%;
            width: 42px;
            height: 42px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }

        .immersive-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }

        .immersive-btn.active {
            background: rgba(255,255,255,0.4);
            border-color: rgba(255,255,255,0.6);
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
        }



        .content {
            padding: 15px 12px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }



        /* Data Manager Styles */
        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: bold;
            color: #333;
            font-size: 13px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Table Management Sidebar */
        .table-sidebar {
            position: fixed;
            top: 0;
            left: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .table-sidebar.open {
            left: 0;
        }

        .table-form-section {
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .copy-form-section {
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .copy-form-section.active {
            display: block;
        }

        .form-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .form-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 2px solid transparent;
        }

        .form-tab.active {
            background: #fff;
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }

        .copy-source-select {
            margin-bottom: 15px;
        }

        .copy-options {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .copy-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .copy-option input[type="radio"] {
            margin-right: 10px;
        }

        .copy-option label {
            font-size: 14px;
            cursor: pointer;
        }

        .copy-preview {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            color: #2e7d32;
            margin-top: 10px;
        }

        .table-controls {
            background: #f0f2f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .table-controls .form-group {
            margin-bottom: 12px;
        }

        .table-controls .form-group:last-child {
            margin-bottom: 0;
        }

        .table-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .table-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }

        .table-item.active {
            background: #e3f2fd;
            border-color: #667eea;
        }

        .table-name {
            font-weight: bold;
            color: #333;
        }

        .table-item-count {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .table-create-time {
            font-size: 11px;
            color: #999;
            margin-top: 2px;
        }

        .table-actions {
            display: flex;
            gap: 5px;
        }

        .select-table-btn {
            padding: 4px 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }

        .copy-table-btn {
            padding: 4px 8px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-left: 5px;
        }

        .delete-table-btn {
            padding: 4px 8px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }
        .sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar.open {
            right: 0;
        }

        .sidebar-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
            white-space: nowrap;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .sidebar-content {
            padding: 20px 15px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 999;
        }

        .overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .controls-section {
            background: #f0f2f5;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .controls-section .form-group {
            margin-bottom: 8px;
        }

        .controls-section .form-group:last-child {
            margin-bottom: 0;
        }

        .create-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
        }

        .data-list {
            max-height: 60vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 3px;
        }

        /* Data Item Swipe Functionality */
        .data-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
            position: relative;
            touch-action: pan-y;
            transition: transform 0.3s ease;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            max-width: 100%;
            box-sizing: border-box;
            min-height: 36px;
        }

        .data-item.swiping {
            touch-action: none;
        }

        .data-item.show-menu {
            transform: translateX(-120px);
        }

        .swipe-menu {
            position: absolute;
            right: -120px;
            top: 0;
            bottom: 0;
            width: 120px;
            background: linear-gradient(135deg, #2196F3, #1976D2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 0 8px 8px 0;
            transition: all 0.3s ease;
            z-index: 10;
            gap: 6px;
            padding: 6px;
        }

        .data-item.show-menu .swipe-menu {
            right: 0;
        }

        .swipe-menu-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 4px;
            padding: 4px 6px;
            font-size: 9px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: bold;
            width: 100%;
            text-align: center;
        }

        .swipe-menu-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .swipe-menu-btn:active {
            transform: scale(0.95);
        }

        .data-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
            gap: 8px;
            min-width: 0;
        }

        .data-name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
            flex: 1;
            min-width: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        .data-value {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            flex-shrink: 0;
            white-space: nowrap;
            max-width: 30%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .data-details {
            font-size: 11px;
            color: #666;
            margin-bottom: 6px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.3;
        }

        .data-operations {
            display: flex;
            gap: 6px;
            align-items: center;
            position: relative;
            flex-wrap: nowrap;
            min-width: 0;
            justify-content: flex-end;
        }

        .data-operations input {
            width: 140px;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .add-value-btn {
            padding: 8px 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            min-width: 65px;
            flex-shrink: 0;
            transition: background-color 0.3s ease;
        }

        .add-value-btn:hover {
            background: #45a049;
        }

        .subtract-value-btn {
            padding: 8px 12px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            min-width: 65px;
            flex-shrink: 0;
            transition: background-color 0.3s ease;
        }

        .subtract-value-btn:hover {
            background: #e68900;
        }

        .delete-btn {
            padding: 8px 12px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            min-width: 65px;
            flex-shrink: 0;
        }

        .summary {
            background: #e8f5e8;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .summary h3 {
            color: #2e7d32;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .summary div {
            margin-bottom: 3px;
            color: #1b5e20;
        }

        .summary div:last-child {
            margin-bottom: 0;
        }

        .table-actions-section {
            margin-bottom: 12px;
            text-align: center;
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .chart-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.3);
        }

        .chart-btn:hover {
            background: linear-gradient(45deg, #1976D2, #1565C0);
            box-shadow: 0 4px 8px rgba(33, 150, 243, 0.4);
            transform: translateY(-1px);
        }

        .chart-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.3);
        }

        .reset-all-btn {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(244, 67, 54, 0.3);
        }

        .reset-all-btn:hover {
            background: linear-gradient(45deg, #d32f2f, #c62828);
            box-shadow: 0 4px 8px rgba(244, 67, 54, 0.4);
            transform: translateY(-1px);
        }

        .reset-all-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(244, 67, 54, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 20px 15px;
            color: #666;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 6px;
            border-radius: 6px;
            margin-bottom: 8px;
            text-align: center;
            display: none;
            font-size: 12px;
        }

        /* Chart Modal Styles */
        .chart-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .chart-modal.open {
            display: flex;
        }

        .chart-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 95vw;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f2f5;
        }

        .chart-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .chart-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .chart-grid {
            display: block;
            margin-bottom: 20px;
        }

        /* Chart Controls */
        .chart-controls {
            background: #f0f2f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .chart-controls .form-group {
            margin-bottom: 0;
        }

        /* Chart Data List */
        .chart-data-list {
            max-height: 70vh;
            overflow-y: auto;
        }

        .chart-data-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 4px;
            border-left: 3px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 36px;
        }

        .chart-item-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            flex: 1;
        }

        .chart-item-value {
            font-weight: bold;
            font-size: 15px;
            color: #2196F3;
            min-width: 60px;
            text-align: right;
        }

        .chart-summary {
            background: #f0f2f5;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 12px;
            font-size: 12px;
            color: #666;
        }

        .chart-summary-inline {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-summary-item {
            text-align: center;
        }

        .chart-summary-value {
            font-weight: bold;
            color: #333;
            margin-top: 2px;
        }

        /* Mobile Optimization for Chart */
        @media (max-width: 480px) {
            .chart-content {
                margin: 5px;
                padding: 10px;
                max-width: calc(100vw - 10px);
                max-height: calc(100vh - 10px);
            }

            .chart-controls {
                padding: 8px;
            }

            .chart-item-name {
                font-size: 13px;
            }

            .chart-item-value {
                font-size: 14px;
                min-width: 50px;
            }

            .chart-title {
                font-size: 16px;
            }
        }
        @media (max-width: 480px) {
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }
            
            body {
                padding: 0;
            }

            .sidebar {
                width: 100vw;
                right: -100vw;
            }

            .table-sidebar {
                width: 100vw;
                left: -100vw;
            }

            .header-controls {
                flex-direction: row;
                gap: 8px;
                justify-content: space-between;
            }

            .table-selector {
                margin-right: 8px;
                flex: 1;
            }
            
            .data-operations {
                gap: 4px;
                justify-content: flex-end;
            }
            
            .data-operations input {
                width: 110px;
                font-size: 13px;
                padding: 6px 8px;
            }
            
            .add-value-btn,
            .subtract-value-btn,
            .delete-btn {
                padding: 6px 8px;
                font-size: 12px;
                min-width: 58px;
            }
            
            .data-name {
                font-size: 14px;
            }
            
            .data-value {
                font-size: 15px;
                max-width: 35%;
            }
            
            .data-item {
                padding: 8px;
                margin-bottom: 6px;
            }
            
            .data-details {
                font-size: 10px;
                margin-bottom: 4px;
            }
            
            .content {
                padding: 10px 8px;
            }
            
            .controls-section {
                padding: 8px;
                margin-bottom: 8px;
            }
            
            .controls-section .form-group {
                margin-bottom: 6px;
            }
            
            .data-list {
                max-height: 65vh;
            }
            
            .table-actions-section {
                margin-bottom: 8px;
            }
            
            .chart-btn,
            .reset-all-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
        }

        /* Immersive Mode Styles */
        body.immersive-mode {
            padding: 0;
            margin: 0;
        }

        body.immersive-mode .container {
            margin: 0;
            border-radius: 0;
            min-height: 100vh;
            max-width: none;
        }

        body.immersive-mode .header {
            padding-top: max(20px, env(safe-area-inset-top));
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
        }

        body.immersive-mode .content {
            padding-left: max(30px, env(safe-area-inset-left) + 10px);
            padding-right: max(30px, env(safe-area-inset-right) + 10px);
            padding-bottom: max(30px, env(safe-area-inset-bottom) + 10px);
        }

        /* Prevent iOS Safari bounce */
        html, body {
            position: fixed;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }

        .container {
            height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: none;
        }

        /* Data History Modal Styles */
        .history-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .history-modal.open {
            display: flex;
        }

        .history-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f2f5;
        }

        .history-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .history-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .history-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .history-item.add {
            border-left-color: #4CAF50;
        }

        .history-item.subtract {
            border-left-color: #ff9800;
        }

        .history-time {
            font-size: 11px;
            color: #999;
            margin-bottom: 5px;
        }

        .history-operation {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .history-operation.add {
            color: #4CAF50;
        }

        .history-operation.subtract {
            color: #ff9800;
        }

        .history-values {
            font-size: 12px;
            color: #666;
        }

        .history-empty {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

        /* Prevent zoom on double tap */
        button, input {
            touch-action: manipulation;
        }

        /* Selective Export Modal Styles */
        .selective-export-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .table-selection-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }

        .table-selection-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }

        .table-selection-item:hover {
            background-color: #f5f5f5;
        }

        .table-selection-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .table-selection-label {
            flex: 1;
            font-size: 14px;
            color: #333;
        }

        .table-selection-info {
            font-size: 12px;
            color: #666;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-controls">
                <div class="table-selector">
                    <select id="tableSelect" onchange="dataManager.switchTable()">
                        <option value="default">ÈªòËÆ§Êï∞ÊçÆË°®</option>
                    </select>
                </div>
                <div class="header-buttons">
                    <button class="add-table-btn" onclick="openTableSidebar()" title="ÁÆ°ÁêÜÊï∞ÊçÆË°®">‚öôÔ∏è</button>
                    <button class="add-btn" onclick="openSidebar()" title="Ê∑ªÂä†Êï∞ÊçÆÈ°π">+</button>
                    <button class="immersive-btn" onclick="toggleImmersiveMode()" title="Ê≤âÊµ∏Ê®°Âºè">üì±</button>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- Data Manager Section -->
            <div id="dataManager" class="section active">
                <div class="success-message" id="successMessage"></div>

                <!-- Search and Sort Controls -->
                <div class="controls-section">
                    <div class="form-group">
                        <label for="searchInput">ÊåâÂêçÁß∞ÊêúÁ¥¢</label>
                        <input type="text" id="searchInput" placeholder="ËæìÂÖ•Êï∞ÊçÆÂêçÁß∞ËøõË°åÊêúÁ¥¢...">
                    </div>
                    
                    <div class="form-group">
                        <label for="sortSelect">ÊéíÂ∫èÊñπÂºè</label>
                        <select id="sortSelect">
                            <option value="none">ÈªòËÆ§ÊéíÂ∫è</option>
                            <option value="value-asc">ÊúÄÁªàÂÄºÔºö‰ªéÂ∞èÂà∞Â§ß</option>
                            <option value="value-desc">ÊúÄÁªàÂÄºÔºö‰ªéÂ§ßÂà∞Â∞è</option>
                            <option value="name-asc">ÂêçÁß∞ÔºöA-Z</option>
                            <option value="name-desc">ÂêçÁß∞ÔºöZ-A</option>
                        </select>
                    </div>
                </div>

                <div id="dataSummary" class="summary" style="display: none;">
                    <h3>Êï∞ÊçÆÊëòË¶Å</h3>
                    <div>ÊÄªÊï∞ÊçÆÈ°π: <span id="totalItems">0</span></div>
                    <div>ÊúÄÁªàÂÄºÊÄªÂíå: <span id="totalSum">0</span></div>
                    <div>ÊúÄÁªàÂÄºÂπ≥Âùá: <span id="averageValue">0</span></div>
                </div>

                <!-- Table Actions -->
                <div class="table-actions-section" id="tableActionsSection" style="display: none;">
                    <button class="chart-btn" onclick="dataManager.showChart()" title="ÊòæÁ§∫ÂΩìÂâçÊï∞ÊçÆË°®ÁöÑÂõæË°®">
                        ÊòæÁ§∫ÂõæË°®
                    </button>
                    <button class="chart-btn" onclick="dataManager.toggleSummary()" title="ÊòæÁ§∫/ÈöêËóèÊï∞ÊçÆÊëòË¶Å">
                        Êï∞ÊçÆÊëòË¶Å
                    </button>
                    <button class="reset-all-btn" onclick="dataManager.resetAllDataToInitial()" title="Â∞ÜÂΩìÂâçÊï∞ÊçÆË°®ÁöÑÊâÄÊúâÊï∞ÊçÆÈ°πÈáçÁΩÆ‰∏∫ÂàùÂßãÂÄº">
                        ÈáçÁΩÆÊâÄÊúâÊï∞ÊçÆ‰∏∫ÂàùÂßãÂÄº
                    </button>
                </div>

                <div class="data-list" id="dataList">
                    <div class="empty-state">
                        <p>ÊöÇÊó†Êï∞ÊçÆÈ°π</p>
                        <p>ËØ∑ÂàõÂª∫Á¨¨‰∏Ä‰∏™Êï∞ÊçÆÈ°π</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="importFileInput" accept=".json" style="display: none;">

    <!-- Data History Modal -->
    <div class="history-modal" id="historyModal" onclick="closeHistory(event)">
        <div class="history-content" onclick="event.stopPropagation()">
            <div class="history-header">
                <div class="history-title" id="historyTitle">‰øÆÊîπÂéÜÂè≤</div>
                <button class="history-close" onclick="closeHistory()">√ó</button>
            </div>
            <div class="history-list" id="historyList">
                <!-- History items will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Chart Modal -->
    <div class="chart-modal" id="chartModal" onclick="closeChart(event)">
        <div class="chart-content" onclick="event.stopPropagation()">
            <div class="chart-header">
                <div class="chart-title" id="chartTitle">Êï∞ÊçÆÂõæË°®</div>
                <button class="chart-close" onclick="closeChart()">√ó</button>
            </div>
            <div class="chart-grid" id="chartGrid">
                <!-- Chart Controls -->
                <div class="chart-controls">
                    <div class="form-group">
                        <label for="chartSort">ÊéíÂ∫èÊñπÂºè</label>
                        <select id="chartSort">
                            <option value="value-desc">ÊúÄÁªàÂÄºÔºö‰ªéÂ§ßÂà∞Â∞è</option>
                            <option value="name-asc">ÂêçÁß∞ÔºöA-Z</option>
                            <option value="name-desc">ÂêçÁß∞ÔºöZ-A</option>
                            <option value="value-asc">ÊúÄÁªàÂÄºÔºö‰ªéÂ∞èÂà∞Â§ß</option>
                        </select>
                    </div>
                </div>
                
                <!-- Chart Data List -->
                <div class="chart-data-list" id="chartDataList">
                    <!-- Chart items will be rendered here -->
                </div>
            </div>
            <div class="chart-summary" id="chartSummary">
                <!-- Summary will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Selective Export Modal -->
    <div class="history-modal" id="selectiveExportModal" onclick="closeSelectiveExport(event)">
        <div class="history-content" onclick="event.stopPropagation()">
            <div class="history-header">
                <div class="history-title">ÈÄâÊã©ÂØºÂá∫Êï∞ÊçÆË°®</div>
                <button class="history-close" onclick="closeSelectiveExport()">√ó</button>
            </div>
            <div class="selective-export-content">
                <div class="selective-export-actions" style="margin-bottom: 15px; text-align: center;">
                    <button class="chart-btn" onclick="selectAllTables()" style="margin-right: 10px;">ÂÖ®ÈÄâ</button>
                    <button class="chart-btn" onclick="deselectAllTables()">ÂèñÊ∂àÂÖ®ÈÄâ</button>
                </div>
                <div class="table-selection-list" id="tableSelectionList">
                    <!-- Table checkboxes will be rendered here -->
                </div>
                <div class="selective-export-buttons" style="margin-top: 20px; text-align: center;">
                    <button class="create-btn" onclick="exportSelectedTables()" style="margin-right: 10px;">ÂØºÂá∫ÈÄâ‰∏≠ÁöÑË°®</button>
                    <button class="chart-btn" onclick="closeSelectiveExport()">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Table Management Sidebar -->
    <div class="overlay" id="tableOverlay" onclick="closeTableSidebar()"></div>
    <div class="table-sidebar" id="tableSidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Êï∞ÊçÆË°®ÁÆ°ÁêÜ</div>
            <button class="close-btn" onclick="closeTableSidebar()">√ó</button>
        </div>
        <div class="sidebar-content">
            <div class="form-tabs">
                <button class="form-tab active" onclick="switchFormTab('create')">ÂàõÂª∫Êï∞ÊçÆË°®</button>
                <button class="form-tab" onclick="switchFormTab('copy')">Â§çÂà∂Êï∞ÊçÆË°®</button>
            </div>
            
            <div class="table-form-section">
                <form id="tableForm">
                    <div class="form-group">
                        <label for="tableName">Êï∞ÊçÆË°®ÂêçÁß∞ *</label>
                        <input type="text" id="tableName" required placeholder="ËæìÂÖ•Êï∞ÊçÆË°®ÂêçÁß∞">
                    </div>
                    
                    <div class="form-group">
                        <label for="tableDescription">ÊèèËø∞ (ÂèØÈÄâ)</label>
                        <input type="text" id="tableDescription" placeholder="ËæìÂÖ•Êï∞ÊçÆË°®ÊèèËø∞">
                    </div>
                    
                    <button type="submit" class="create-btn">ÂàõÂª∫Êï∞ÊçÆË°®</button>
                </form>
            </div>
            
            <div class="copy-form-section">
                <form id="copyTableForm">
                    <div class="copy-source-select">
                        <div class="form-group">
                            <label for="sourceTable">ÈÄâÊã©Ë¶ÅÂ§çÂà∂ÁöÑÊï∞ÊçÆË°®</label>
                            <select id="sourceTable" required>
                                <option value="">ËØ∑ÈÄâÊã©Êï∞ÊçÆË°®</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="copyTableName">Êñ∞Êï∞ÊçÆË°®ÂêçÁß∞ *</label>
                        <input type="text" id="copyTableName" required placeholder="ËæìÂÖ•Êñ∞ÁöÑÊï∞ÊçÆË°®ÂêçÁß∞">
                    </div>
                    
                    <div class="form-group">
                        <label for="copyTableDescription">ÊèèËø∞ (ÂèØÈÄâ)</label>
                        <input type="text" id="copyTableDescription" placeholder="ËæìÂÖ•Êï∞ÊçÆË°®ÊèèËø∞">
                    </div>
                    
                    <div class="copy-options">
                        <h4>Êï∞ÊçÆÂ§çÂà∂ÈÄâÈ°π</h4>
                        <div class="copy-option">
                            <input type="radio" id="keepValues" name="copyOption" value="keep" checked>
                            <label for="keepValues">‰øùÊåÅÂΩìÂâçÊï∞ÂÄºÔºàÂ§çÂà∂ÊâÄÊúâÊï∞ÊçÆÁöÑÂΩìÂâçÁä∂ÊÄÅÔºâ</label>
                        </div>
                        <div class="copy-option">
                            <input type="radio" id="resetValues" name="copyOption" value="reset">
                            <label for="resetValues">ÈáçÁΩÆ‰∏∫ÂàùÂßãÂÄºÔºàÊâÄÊúâÊï∞ÊçÆÂÄºÊÅ¢Â§çÂà∞ÂàùÂßãÁä∂ÊÄÅÔºâ</label>
                        </div>
                        <div class="copy-preview" id="copyPreview">
                            ËØ∑ÈÄâÊã©Ë¶ÅÂ§çÂà∂ÁöÑÊï∞ÊçÆË°®Êü•ÁúãÈ¢ÑËßà
                        </div>
                    </div>
                    
                    <button type="submit" class="create-btn">Â§çÂà∂Êï∞ÊçÆË°®</button>
                </form>
            </div>
            
            <div class="table-list-section">
                <h3>ÊâÄÊúâÊï∞ÊçÆË°®</h3>
                
                <!-- Selective Export/Import Actions -->
                <div class="selective-actions" style="margin-bottom: 15px;">
                    <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 10px;">
                        <button class="chart-btn" onclick="dataManager.showSelectiveExport()" title="ÈÄâÊã©Êï∞ÊçÆË°®ÂØºÂá∫">
                            ÂØºÂá∫Êï∞ÊçÆ
                        </button>
                        <button class="chart-btn" onclick="dataManager.importAllTables()" title="ÂØºÂÖ•Êï∞ÊçÆË°®">
                            ÂØºÂÖ•Êï∞ÊçÆ
                        </button>
                    </div>
                </div>
                
                <!-- Table Search and Sort Controls -->
                <div class="table-controls">
                    <div class="form-group">
                        <label for="tableSearch">ÊåâÂêçÁß∞ÊêúÁ¥¢</label>
                        <input type="text" id="tableSearch" placeholder="ËæìÂÖ•Êï∞ÊçÆË°®ÂêçÁß∞ËøõË°åÊêúÁ¥¢...">
                    </div>
                    
                    <div class="form-group">
                        <label for="tableSort">ÊéíÂ∫èÊñπÂºè</label>
                        <select id="tableSort">
                            <option value="name-asc">ÂêçÁß∞ÔºöA-Z</option>
                            <option value="name-desc">ÂêçÁß∞ÔºöZ-A</option>
                            <option value="time-desc">ÂàõÂª∫Êó∂Èó¥ÔºöÊñ∞Âà∞Êóß</option>
                            <option value="time-asc">ÂàõÂª∫Êó∂Èó¥ÔºöÊóßÂà∞Êñ∞</option>
                            <option value="items-desc">Êï∞ÊçÆÈ°πÔºöÂ§öÂà∞Â∞ë</option>
                            <option value="items-asc">Êï∞ÊçÆÈ°πÔºöÂ∞ëÂà∞Â§ö</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-list" id="tableList">
                    <!-- Tables will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar for Creating Data -->
    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">ÂàõÂª∫Êñ∞Êï∞ÊçÆÈ°π</div>
            <button class="close-btn" onclick="closeSidebar()">√ó</button>
        </div>
        <div class="sidebar-content">
            <form id="dataForm">
                <div class="form-group">
                    <label for="dataName">Êï∞ÊçÆÂêçÁß∞ *</label>
                    <input type="text" id="dataName" required>
                </div>
                
                <div class="form-group">
                    <label for="initialValue">ÂàùÂßãÂÄº *</label>
                    <input type="number" id="initialValue" step="any" required>
                </div>
                
                <div class="form-group">
                    <label for="dataDescription">ÊèèËø∞ (ÂèØÈÄâ)</label>
                    <input type="text" id="dataDescription">
                </div>
                
                <button type="submit" class="create-btn">ÂàõÂª∫Êï∞ÊçÆÈ°π</button>
            </form>
        </div>
    </div>

    <script>
        // Initialize localforage instances
        const dataManagerStore = localforage.createInstance({
            name: 'CounterApp',
            storeName: 'dataManager'
        });

        const tableManagerStore = localforage.createInstance({
            name: 'CounterApp',
            storeName: 'tableManager'
        });



        // Data Manager functionality
        class DataManager {
            constructor() {
                this.dataItems = [];
                this.filteredItems = [];
                this.searchTerm = '';
                this.sortOrder = 'none';
                this.currentTable = 'default';
                this.dataTables = [];
                this.filteredTables = [];
                this.tableSearchTerm = '';
                this.tableSortOrder = 'name-asc';
                this.operationModes = {}; // Track operation mode for each item (add/subtract)
                this.loadTables();
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                // Search input event listener
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.searchTerm = e.target.value.toLowerCase();
                    this.applyFiltersAndSort();
                });

                // Sort select event listener
                document.getElementById('sortSelect').addEventListener('change', (e) => {
                    this.sortOrder = e.target.value;
                    this.applyFiltersAndSort();
                });
                
                // Table search event listener
                document.getElementById('tableSearch').addEventListener('input', (e) => {
                    this.tableSearchTerm = e.target.value.toLowerCase();
                    this.applyTableFiltersAndSort();
                });
                
                // Table sort event listener
                document.getElementById('tableSort').addEventListener('change', (e) => {
                    this.tableSortOrder = e.target.value;
                    this.applyTableFiltersAndSort();
                });
            }

            applyFiltersAndSort() {
                // Apply search filter
                this.filteredItems = this.dataItems.filter(item => 
                    item.name.toLowerCase().includes(this.searchTerm)
                );

                // Apply sorting
                switch (this.sortOrder) {
                    case 'value-asc':
                        this.filteredItems.sort((a, b) => a.currentValue - b.currentValue);
                        break;
                    case 'value-desc':
                        this.filteredItems.sort((a, b) => b.currentValue - a.currentValue);
                        break;
                    case 'name-asc':
                        this.filteredItems.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                    case 'name-desc':
                        this.filteredItems.sort((a, b) => b.name.localeCompare(a.name));
                        break;
                    default:
                        // Keep original order (by creation time)
                        this.filteredItems.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                }

                this.renderDataList();
            }

            applyTableFiltersAndSort() {
                // Apply search filter for tables
                this.filteredTables = this.dataTables.filter(table => 
                    table.name.toLowerCase().includes(this.tableSearchTerm)
                );

                // Apply sorting for tables
                switch (this.tableSortOrder) {
                    case 'name-asc':
                        this.filteredTables.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                    case 'name-desc':
                        this.filteredTables.sort((a, b) => b.name.localeCompare(a.name));
                        break;
                    case 'time-desc':
                        this.filteredTables.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        break;
                    case 'time-asc':
                        this.filteredTables.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                        break;
                    case 'items-desc':
                        this.filteredTables.sort((a, b) => this.getTableItemCount(b.id) - this.getTableItemCount(a.id));
                        break;
                    case 'items-asc':
                        this.filteredTables.sort((a, b) => this.getTableItemCount(a.id) - this.getTableItemCount(b.id));
                        break;
                    default:
                        // Keep original order (by creation time)
                        this.filteredTables.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                }

                this.renderTableList();
            }

            async loadTables() {
                try {
                    const tables = await tableManagerStore.getItem('dataTables');
                    this.dataTables = tables || [{
                        id: 'default',
                        name: 'ÈªòËÆ§Êï∞ÊçÆË°®',
                        description: 'Á≥ªÁªüÈªòËÆ§Êï∞ÊçÆË°®',
                        createdAt: new Date().toISOString()
                    }];
                    
                    // Update item counts for all tables
                    await this.updateAllTableItemCounts();
                    
                    this.renderTableSelector();
                    this.applyTableFiltersAndSort();
                    await this.loadData();
                } catch (error) {
                    console.error('Error loading tables:', error);
                }
            }

            async saveTables() {
                try {
                    await tableManagerStore.setItem('dataTables', this.dataTables);
                } catch (error) {
                    console.error('Error saving tables:', error);
                }
            }

            async loadData() {
                try {
                    const data = await dataManagerStore.getItem(`dataItems_${this.currentTable}`);
                    this.dataItems = data || [];
                    this.applyFiltersAndSort();
                    this.updateSummary();
                } catch (error) {
                    console.error('Error loading data manager data:', error);
                }
            }

            async saveData() {
                try {
                    await dataManagerStore.setItem(`dataItems_${this.currentTable}`, this.dataItems);
                } catch (error) {
                    console.error('Error saving data manager data:', error);
                }
            }

            createTable(name, description = '') {
                const tableId = this.generateId();
                const newTable = {
                    id: tableId,
                    name: name,
                    description: description,
                    createdAt: new Date().toISOString()
                };

                this.dataTables.push(newTable);
                this.saveTables();
                
                // Update item counts after creating new table
                this.updateAllTableItemCounts().then(() => {
                    this.renderTableSelector();
                    this.applyTableFiltersAndSort();
                });
                
                this.showSuccessMessage('Êï∞ÊçÆË°®ÂàõÂª∫ÊàêÂäüÔºÅ');
                return tableId;
            }

            async switchTable(tableId = null) {
                if (!tableId) {
                    tableId = document.getElementById('tableSelect').value;
                }
                
                this.currentTable = tableId;
                await this.loadData();
                
                // Update item counts after switching
                await this.updateAllTableItemCounts();
                this.applyTableFiltersAndSort();
                
                // Update current table display
                const currentTableName = this.dataTables.find(t => t.id === tableId)?.name || 'Êú™Áü•Êï∞ÊçÆË°®';
                document.getElementById('tableSelect').value = tableId;
            }

            deleteTable(tableId) {
                if (tableId === 'default') {
                    alert('ÈªòËÆ§Êï∞ÊçÆË°®‰∏çËÉΩÂà†Èô§');
                    return;
                }
                
                if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êï∞ÊçÆË°®ÂêóÔºüËøôÂ∞ÜÂêåÊó∂Âà†Èô§ÂÖ∂‰∏≠ÁöÑÊâÄÊúâÊï∞ÊçÆ„ÄÇ')) {
                    // Delete table data
                    dataManagerStore.removeItem(`dataItems_${tableId}`);
                    
                    // Remove from tables list
                    this.dataTables = this.dataTables.filter(table => table.id !== tableId);
                    this.saveTables();
                    
                    // Switch to default table if current table is deleted
                    if (this.currentTable === tableId) {
                        this.switchTable('default');
                    }
                    
                    this.renderTableSelector();
                    this.applyTableFiltersAndSort();
                    this.showSuccessMessage('Êï∞ÊçÆË°®Âà†Èô§ÊàêÂäüÔºÅ');
                }
            }

            renderTableSelector() {
                const tableSelect = document.getElementById('tableSelect');
                tableSelect.innerHTML = this.dataTables.map(table => 
                    `<option value="${table.id}">${table.name}</option>`
                ).join('');
                tableSelect.value = this.currentTable;
            }

            renderTableList() {
                const tableList = document.getElementById('tableList');
                
                if (this.dataTables.length === 0) {
                    tableList.innerHTML = `
                        <div class="empty-state">
                            <p>ÊöÇÊó†Êï∞ÊçÆË°®</p>
                        </div>
                    `;
                    return;
                }

                if (this.filteredTables.length === 0) {
                    tableList.innerHTML = `
                        <div class="empty-state">
                            <p>Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÊï∞ÊçÆË°®</p>
                            <p>ËØ∑Â∞ùËØïÂÖ∂‰ªñÊêúÁ¥¢Êù°‰ª∂</p>
                        </div>
                    `;
                    return;
                }
                
                tableList.innerHTML = this.filteredTables.map(table => {
                    const itemCount = this.getTableItemCount(table.id);
                    const isActive = table.id === this.currentTable;
                    const createTime = this.formatDateTime(table.createdAt);
                    
                    return `
                        <div class="table-item ${isActive ? 'active' : ''}">
                            <div>
                                <div class="table-name">${table.name}</div>
                                <div class="table-item-count">${itemCount} ‰∏™Êï∞ÊçÆÈ°π | ${table.description || 'Êó†ÊèèËø∞'}</div>
                                <div class="table-create-time">ÂàõÂª∫Êó∂Èó¥Ôºö${createTime}</div>
                            </div>
                            <div class="table-actions">
                                ${!isActive ? `<button class="select-table-btn" onclick="dataManager.switchTable('${table.id}')">ÈÄâÊã©</button>` : '<span style="color: #667eea; font-size: 11px;">ÂΩìÂâç</span>'}
                                <button class="copy-table-btn" onclick="dataManager.initCopyTable('${table.id}')">Â§çÂà∂</button>
                                ${table.id !== 'default' ? `<button class="delete-table-btn" onclick="dataManager.deleteTable('${table.id}')">Âà†Èô§</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Update copy form source options
                this.updateCopySourceOptions();
            }

            getTableItemCount(tableId) {
                if (tableId === this.currentTable) {
                    return this.dataItems.length;
                }
                // For other tables, we need to get their actual data count
                // This is a synchronous method, so we'll use a cached approach
                if (this.tableItemCounts && this.tableItemCounts[tableId] !== undefined) {
                    return this.tableItemCounts[tableId];
                }
                return 0; // Default to 0 if not cached
            }

            async updateAllTableItemCounts() {
                this.tableItemCounts = {};
                for (const table of this.dataTables) {
                    try {
                        const data = await dataManagerStore.getItem(`dataItems_${table.id}`);
                        this.tableItemCounts[table.id] = data ? data.length : 0;
                    } catch (error) {
                        console.error(`Error loading data for table ${table.id}:`, error);
                        this.tableItemCounts[table.id] = 0;
                    }
                }
            }

            generateId() {
                const timestamp = Date.now();
                const random = Math.random().toString(36).substr(2, 9);
                return `data_${timestamp}_${random}`;
            }

            updateCopySourceOptions() {
                const sourceSelect = document.getElementById('sourceTable');
                if (sourceSelect) {
                    sourceSelect.innerHTML = `
                        <option value="">ËØ∑ÈÄâÊã©Êï∞ÊçÆË°®</option>
                        ${this.dataTables.map(table => 
                            `<option value="${table.id}">${table.name} (${this.getTableItemCount(table.id)} ‰∏™Êï∞ÊçÆÈ°π)</option>`
                        ).join('')}
                    `;
                }
            }

            initCopyTable(tableId) {
                // Switch to copy tab and pre-select the table
                switchFormTab('copy');
                setTimeout(() => {
                    const sourceSelect = document.getElementById('sourceTable');
                    if (sourceSelect) {
                        sourceSelect.value = tableId;
                        this.updateCopyPreview();
                    }
                    // Auto-fill description when initializing copy
                    autoFillCopyTime();
                }, 100);
            }

            async updateCopyPreview() {
                const sourceTableId = document.getElementById('sourceTable').value;
                const copyOption = document.querySelector('input[name="copyOption"]:checked').value;
                const previewEl = document.getElementById('copyPreview');
                
                if (!sourceTableId) {
                    previewEl.textContent = 'ËØ∑ÈÄâÊã©Ë¶ÅÂ§çÂà∂ÁöÑÊï∞ÊçÆË°®Êü•ÁúãÈ¢ÑËßà';
                    return;
                }
                
                try {
                    const sourceData = await dataManagerStore.getItem(`dataItems_${sourceTableId}`);
                    const itemCount = sourceData ? sourceData.length : 0;
                    const sourceTable = this.dataTables.find(t => t.id === sourceTableId);
                    
                    if (copyOption === 'keep') {
                        previewEl.innerHTML = `
                            Â∞ÜÂ§çÂà∂ "${sourceTable?.name || 'Êú™Áü•'}" Êï∞ÊçÆË°®ÁöÑ ${itemCount} ‰∏™Êï∞ÊçÆÈ°πÔºå<strong>‰øùÊåÅÂΩìÂâçÊï∞ÂÄº</strong>„ÄÇ
                        `;
                    } else {
                        previewEl.innerHTML = `
                            Â∞ÜÂ§çÂà∂ "${sourceTable?.name || 'Êú™Áü•'}" Êï∞ÊçÆË°®ÁöÑ ${itemCount} ‰∏™Êï∞ÊçÆÈ°πÔºå<strong>ÊâÄÊúâÊï∞ÂÄºÈáçÁΩÆ‰∏∫ÂàùÂßãÂÄº</strong>„ÄÇ
                        `;
                    }
                } catch (error) {
                    previewEl.textContent = 'È¢ÑËßàÂä†ËΩΩÂ§±Ë¥•';
                }
            }

            async copyTable(sourceTableId, newName, newDescription, resetValues) {
                try {
                    // Get source table data
                    const sourceData = await dataManagerStore.getItem(`dataItems_${sourceTableId}`) || [];
                    const sourceTable = this.dataTables.find(t => t.id === sourceTableId);
                    
                    if (!sourceTable) {
                        throw new Error('Ê∫êÊï∞ÊçÆË°®‰∏çÂ≠òÂú®');
                    }
                    
                    // Create new table
                    const newTableId = this.generateId();
                    const newTable = {
                        id: newTableId,
                        name: newName,
                        description: newDescription,
                        createdAt: new Date().toISOString()
                    };
                    
                    // Copy and process data items
                    const copiedData = sourceData.map(item => {
                        const newItem = {
                            ...item,
                            id: this.generateId(),
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        if (resetValues) {
                            // Reset to initial values
                            newItem.currentValue = item.initialValue;
                            newItem.operationHistory = [];
                        } else {
                            // Keep current values but clear operation history for the copy
                            newItem.operationHistory = [...item.operationHistory];
                        }
                        
                        return newItem;
                    });
                    
                    // Save new table and its data
                    this.dataTables.push(newTable);
                    await this.saveTables();
                    await dataManagerStore.setItem(`dataItems_${newTableId}`, copiedData);
                    
                    // Update UI
                    this.renderTableSelector();
                    
                    // Update item counts after copying table
                    this.updateAllTableItemCounts().then(() => {
                        this.applyTableFiltersAndSort();
                    });
                    
                    this.showSuccessMessage(`Êï∞ÊçÆË°® "${newName}" Â§çÂà∂ÊàêÂäüÔºÅÂÖ±Â§çÂà∂‰∫Ü ${copiedData.length} ‰∏™Êï∞ÊçÆÈ°π„ÄÇ`);
                    
                    return newTableId;
                } catch (error) {
                    console.error('Error copying table:', error);
                    alert('Â§çÂà∂Êï∞ÊçÆË°®Â§±Ë¥•Ôºö' + error.message);
                    return null;
                }
            }

            formatDateTime(isoString) {
                const date = new Date(isoString);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            resetAllDataToInitial() {
                if (this.dataItems.length === 0) {
                    alert('ÂΩìÂâçÊï∞ÊçÆË°®‰∏≠Ê≤°ÊúâÊï∞ÊçÆÈ°π');
                    return;
                }
                
                const currentTableName = this.dataTables.find(t => t.id === this.currentTable)?.name || 'ÂΩìÂâçÊï∞ÊçÆË°®';
                const itemCount = this.dataItems.length;
                
                const confirmMessage = `Á°ÆÂÆöË¶ÅÂ∞Ü "${currentTableName}" ‰∏≠ÁöÑÊâÄÊúâ ${itemCount} ‰∏™Êï∞ÊçÆÈ°πÈáçÁΩÆ‰∏∫ÂàùÂßãÂÄºÂêóÔºü\n\nÊ≠§Êìç‰ΩúÂ∞ÜÔºö\n- ÊâÄÊúâÊï∞ÊçÆÁöÑÂΩìÂâçÂÄºÊÅ¢Â§çÂà∞ÂàùÂßãÂÄº\n- Ê∏ÖÁ©∫ÊâÄÊúâÊìç‰ΩúÂéÜÂè≤\n- Êõ¥Êñ∞‰øÆÊîπÊó∂Èó¥\n\nÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ`;
                
                if (confirm(confirmMessage)) {
                    // Reset all data items to initial values
                    this.dataItems.forEach(item => {
                        item.currentValue = item.initialValue;
                        item.updatedAt = new Date().toISOString();
                        item.operationHistory = []; // Clear operation history
                    });
                    
                    // Save the changes
                    this.saveData();
                    
                    // Update the display
                    this.applyFiltersAndSort();
                    this.updateSummary();
                    
                    // Show success message
                    this.showSuccessMessage(`ÊàêÂäüÈáçÁΩÆ‰∫Ü ${itemCount} ‰∏™Êï∞ÊçÆÈ°πÂà∞ÂàùÂßãÂÄºÔºÅ`);
                }
            }

            showChart() {
                if (this.dataItems.length === 0) {
                    alert('ÂΩìÂâçÊï∞ÊçÆË°®‰∏≠Ê≤°ÊúâÊï∞ÊçÆÈ°π');
                    return;
                }
                
                const currentTableName = this.dataTables.find(t => t.id === this.currentTable)?.name || 'ÂΩìÂâçÊï∞ÊçÆË°®';
                
                // Update chart title
                document.getElementById('chartTitle').textContent = `${currentTableName} - Êï∞ÊçÆÂõæË°®`;
                
                // Render chart items
                this.renderChartItems();
                
                // Render chart summary
                this.renderChartSummary();
                
                // Show modal
                document.getElementById('chartModal').classList.add('open');
            }

            renderChartItems() {
                const chartDataList = document.getElementById('chartDataList');
                const chartSort = document.getElementById('chartSort').value;
                
                // Create a copy of data items for sorting
                let sortedItems = [...this.dataItems];
                
                // Apply sorting
                switch (chartSort) {
                    case 'name-asc':
                        sortedItems.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                    case 'name-desc':
                        sortedItems.sort((a, b) => b.name.localeCompare(a.name));
                        break;
                    case 'value-desc':
                        sortedItems.sort((a, b) => b.currentValue - a.currentValue);
                        break;
                    case 'value-asc':
                        sortedItems.sort((a, b) => a.currentValue - b.currentValue);
                        break;
                    default:
                        // Keep original order
                        break;
                }
                
                chartDataList.innerHTML = sortedItems.map((item) => {
                    return `
                        <div class="chart-data-item">
                            <div class="chart-item-name">${item.name}</div>
                            <div class="chart-item-value">${item.currentValue}</div>
                        </div>
                    `;
                }).join('');
            }

            renderChartSummary() {
                const chartSummary = document.getElementById('chartSummary');
                
                const totalItems = this.dataItems.length;
                const totalCurrent = this.dataItems.reduce((sum, item) => sum + item.currentValue, 0);
                const totalChange = this.dataItems.reduce((sum, item) => sum + (item.currentValue - item.initialValue), 0);
                const averageCurrent = totalCurrent / totalItems;
                
                chartSummary.innerHTML = `
                    <div class="chart-summary-inline">
                        <div class="chart-summary-item">
                            <div>ÊÄªÊï∞</div>
                            <div class="chart-summary-value">${totalItems}</div>
                        </div>
                        <div class="chart-summary-item">
                            <div>ÊÄªÂÄº</div>
                            <div class="chart-summary-value">${totalCurrent.toFixed(1)}</div>
                        </div>
                        <div class="chart-summary-item">
                            <div>ÂèòÂåñ</div>
                            <div class="chart-summary-value">${totalChange >= 0 ? '+' : ''}${totalChange.toFixed(1)}</div>
                        </div>
                        <div class="chart-summary-item">
                            <div>Âπ≥Âùá</div>
                            <div class="chart-summary-value">${averageCurrent.toFixed(1)}</div>
                        </div>
                    </div>
                `;
            }

            createDataItem(name, initialValue, description = '') {
                const dataItem = {
                    id: this.generateId(),
                    name: name,
                    initialValue: parseFloat(initialValue),
                    currentValue: parseFloat(initialValue),
                    description: description,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    operationHistory: []
                };

                this.dataItems.push(dataItem);
                this.saveData();
                
                // Update item counts after creating new data
                this.updateAllTableItemCounts().then(() => {
                    this.applyTableFiltersAndSort();
                });
                
                this.applyFiltersAndSort();
                this.updateSummary();
                this.showSuccessMessage('Êï∞ÊçÆÈ°πÂàõÂª∫ÊàêÂäüÔºÅ');
            }

            addValue(id, value) {
                const item = this.dataItems.find(item => item.id === id);
                if (item) {
                    const oldValue = item.currentValue;
                    const addValue = parseFloat(value);
                    item.currentValue += addValue;
                    item.updatedAt = new Date().toISOString();
                    
                    item.operationHistory.push({
                        timestamp: new Date().toISOString(),
                        operation: 'add',
                        value: addValue,
                        oldValue: oldValue,
                        newValue: item.currentValue
                    });

                    this.saveData();
                    this.applyFiltersAndSort();
                    this.updateSummary();
                }
            }

            subtractValue(id, value) {
                const item = this.dataItems.find(item => item.id === id);
                if (item) {
                    const oldValue = item.currentValue;
                    const subtractValue = parseFloat(value);
                    item.currentValue -= subtractValue;
                    item.updatedAt = new Date().toISOString();
                    
                    item.operationHistory.push({
                        timestamp: new Date().toISOString(),
                        operation: 'subtract',
                        value: subtractValue,
                        oldValue: oldValue,
                        newValue: item.currentValue
                    });

                    this.saveData();
                    this.applyFiltersAndSort();
                    this.updateSummary();
                }
            }

            deleteDataItem(id) {
                if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êï∞ÊçÆÈ°πÂêóÔºü')) {
                    this.dataItems = this.dataItems.filter(item => item.id !== id);
                    this.saveData();
                    
                    // Update item counts after deleting data
                    this.updateAllTableItemCounts().then(() => {
                        this.applyTableFiltersAndSort();
                    });
                    
                    this.applyFiltersAndSort();
                    this.updateSummary();
                    this.showSuccessMessage('Êï∞ÊçÆÈ°πÂà†Èô§ÊàêÂäüÔºÅ');
                }
            }

            renderDataList() {
                const dataList = document.getElementById('dataList');
                
                if (this.dataItems.length === 0) {
                    dataList.innerHTML = `
                        <div class="empty-state">
                            <p>ÊöÇÊó†Êï∞ÊçÆÈ°π</p>
                            <p>ËØ∑ÂàõÂª∫Á¨¨‰∏Ä‰∏™Êï∞ÊçÆÈ°π</p>
                        </div>
                    `;
                    return;
                }

                if (this.filteredItems.length === 0) {
                    dataList.innerHTML = `
                        <div class="empty-state">
                            <p>Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÊï∞ÊçÆÈ°π</p>
                            <p>ËØ∑Â∞ùËØïÂÖ∂‰ªñÊêúÁ¥¢Êù°‰ª∂</p>
                        </div>
                    `;
                    return;
                }

                dataList.innerHTML = this.filteredItems.map(item => {
                    const operationMode = this.operationModes[item.id] || 'add';
                    const isAdd = operationMode === 'add';
                    
                    return `
                        <div class="data-item" data-item-id="${item.id}">
                            <div class="data-header">
                                <div class="data-name">${item.name}</div>
                                <div class="data-value">${item.currentValue}</div>
                            </div>
                            <div class="data-details">
                                ÂàùÂßãÂÄº: ${item.initialValue} | ${item.description || 'Êó†ÊèèËø∞'}
                            </div>
                            <div class="data-operations">
                                <input type="number" step="any" placeholder="ËæìÂÖ•Êï∞ÂÄº" id="input_${item.id}">
                                <button class="${isAdd ? 'add-value-btn' : 'subtract-value-btn'}" onclick="dataManager.performOperation('${item.id}')" title="${isAdd ? 'Ê∑ªÂä†Êï∞ÂÄº' : 'ÂáèÂ∞ëÊï∞ÂÄº'}">
                                    ${isAdd ? 'Âä†' : 'Âáè'}
                                </button>
                                <button class="delete-btn" onclick="dataManager.deleteDataItem('${item.id}')">Âà†Èô§</button>
                            </div>
                            <div class="swipe-menu">
                                <button class="swipe-menu-btn" onclick="dataManager.toggleOperationMode('${item.id}'); dataManager.hideSwipeMenu('${item.id}')">
                                    ÂàáÊç¢‰∏∫${isAdd ? 'Âáè' : 'Âä†'}
                                </button>
                                <button class="swipe-menu-btn" onclick="dataManager.showDataHistory('${item.id}'); dataManager.hideSwipeMenu('${item.id}')">
                                    ‰øÆÊîπÂéÜÂè≤
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Initialize swipe functionality for data items
                this.initializeSwipeGestures();
            }

            initializeSwipeGestures() {
                const dataItems = document.querySelectorAll('.data-item');
                
                dataItems.forEach(item => {
                    let startX = 0;
                    let startY = 0;
                    let currentX = 0;
                    let currentY = 0;
                    let isSwipeActive = false;
                    let isMenuOpen = false;
                    let swipeDirection = null;
                    
                    const handleStart = (e) => {
                        // Don't start swipe if clicking on buttons
                        if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') {
                            return;
                        }
                        
                        const touch = e.type === 'touchstart' ? e.touches[0] : e;
                        startX = touch.clientX;
                        startY = touch.clientY;
                        currentX = startX;
                        currentY = startY;
                        isSwipeActive = true;
                        swipeDirection = null;
                        item.classList.add('swiping');
                        console.log('Swipe started:', startX, startY);
                    };
                    
                    const handleMove = (e) => {
                        if (!isSwipeActive) return;
                        
                        const touch = e.type === 'touchmove' ? e.touches[0] : e;
                        currentX = touch.clientX;
                        currentY = touch.clientY;
                        
                        const deltaX = startX - currentX;
                        const deltaY = startY - currentY;
                        
                        // Determine swipe direction on first significant movement
                        if (swipeDirection === null && (Math.abs(deltaX) > 10 || Math.abs(deltaY) > 10)) {
                            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                                swipeDirection = 'horizontal';
                            } else {
                                swipeDirection = 'vertical';
                            }
                        }
                        
                        // Only handle horizontal swipes
                        if (swipeDirection === 'horizontal') {
                            e.preventDefault();
                            console.log('Horizontal swipe move:', deltaX);
                            
                            // Only show menu when swiping left (positive deltaX)
                            if (deltaX > 30) {
                                item.classList.add('show-menu');
                                isMenuOpen = true;
                                console.log('Menu should be visible now');
                            } else if (deltaX < -30) {
                                // Swipe right to close menu
                                item.classList.remove('show-menu');
                                isMenuOpen = false;
                            }
                        }
                        // Allow vertical scrolling for vertical swipes
                        else if (swipeDirection === 'vertical') {
                            // Don't prevent default for vertical scrolling
                            isSwipeActive = false;
                            item.classList.remove('swiping');
                        }
                    };
                    
                    const handleEnd = (e) => {
                        if (!isSwipeActive) return;
                        
                        isSwipeActive = false;
                        item.classList.remove('swiping');
                        
                        // Only process end for horizontal swipes
                        if (swipeDirection === 'horizontal') {
                            const deltaX = startX - currentX;
                            
                            // Show menu if swiped left enough
                            if (deltaX > 60) {
                                item.classList.add('show-menu');
                                isMenuOpen = true;
                            } else if (deltaX < -30 || Math.abs(deltaX) < 30) {
                                // Hide menu if swiped right or small movement
                                item.classList.remove('show-menu');
                                isMenuOpen = false;
                            }
                        }
                        
                        swipeDirection = null;
                    };
                    
                    // Close menu when clicking outside
                    const handleClickOutside = (e) => {
                        if (isMenuOpen && !item.contains(e.target)) {
                            item.classList.remove('show-menu');
                            isMenuOpen = false;
                        }
                    };
                    
                    // Touch events with passive: false only for touchmove when needed
                    item.addEventListener('touchstart', handleStart, { passive: true });
                    item.addEventListener('touchmove', handleMove, { passive: false });
                    item.addEventListener('touchend', handleEnd, { passive: true });
                    
                    // Mouse events for desktop testing
                    item.addEventListener('mousedown', handleStart);
                    item.addEventListener('mousemove', handleMove);
                    item.addEventListener('mouseup', handleEnd);
                    item.addEventListener('mouseleave', handleEnd);
                    
                    // Close menu when clicking outside
                    document.addEventListener('click', handleClickOutside);
                });
            }

            toggleOperationMode(id) {
                const currentMode = this.operationModes[id] || 'add';
                this.operationModes[id] = currentMode === 'add' ? 'subtract' : 'add';
                
                // Re-render to update the UI
                this.applyFiltersAndSort();
            }

            showSwipeMenu(id) {
                const dataItem = document.querySelector(`[data-item-id="${id}"]`);
                if (dataItem) {
                    dataItem.classList.add('show-menu');
                    console.log('Menu shown for item:', id);
                }
            }

            showDataHistory(id) {
                const item = this.dataItems.find(item => item.id === id);
                if (!item) return;
                
                const historyTitle = document.getElementById('historyTitle');
                const historyList = document.getElementById('historyList');
                
                historyTitle.textContent = `${item.name} - ‰øÆÊîπÂéÜÂè≤`;
                
                if (!item.operationHistory || item.operationHistory.length === 0) {
                    historyList.innerHTML = `
                        <div class="history-empty">
                            <p>ÊöÇÊó†‰øÆÊîπÂéÜÂè≤</p>
                            <p>ËØ•Êï∞ÊçÆÈ°πÂ∞öÊú™ËøõË°å‰ªª‰ΩïÊìç‰Ωú</p>
                        </div>
                    `;
                } else {
                    // Sort history by timestamp (newest first)
                    const sortedHistory = [...item.operationHistory].sort((a, b) => 
                        new Date(b.timestamp) - new Date(a.timestamp)
                    );
                    
                    historyList.innerHTML = sortedHistory.map(operation => {
                        const operationType = operation.operation === 'add' ? 'add' : 'subtract';
                        const operationText = operation.operation === 'add' ? 'Âä†Ê≥ïÊìç‰Ωú' : 'ÂáèÊ≥ïÊìç‰Ωú';
                        const valueChange = operation.operation === 'add' ? 
                            `+${operation.value}` : `-${operation.value}`;
                        
                        const time = new Date(operation.timestamp).toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                        
                        return `
                            <div class="history-item ${operationType}">
                                <div class="history-time">${time}</div>
                                <div class="history-operation ${operationType}">${operationText}: ${valueChange}</div>
                                <div class="history-values">
                                    ${operation.oldValue.toFixed(2)} ‚Üí ${operation.newValue.toFixed(2)}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                document.getElementById('historyModal').classList.add('open');
            }

            hideSwipeMenu(id) {
                const dataItem = document.querySelector(`[data-item-id="${id}"]`);
                if (dataItem) {
                    dataItem.classList.remove('show-menu');
                }
            }

            performOperation(id) {
                const operationMode = this.operationModes[id] || 'add';
                
                if (operationMode === 'add') {
                    this.addValueFromInput(id);
                } else {
                    this.subtractValueFromInput(id);
                }
            }

            addValueFromInput(id) {
                const input = document.getElementById(`input_${id}`);
                const value = input.value;
                
                if (value && !isNaN(parseFloat(value))) {
                    this.addValue(id, value);
                    input.value = '';
                } else {
                    alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊï∞ÂÄº');
                }
            }

            subtractValueFromInput(id) {
                const input = document.getElementById(`input_${id}`);
                const value = input.value;
                
                if (value && !isNaN(parseFloat(value))) {
                    this.subtractValue(id, value);
                    input.value = '';
                } else {
                    alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊï∞ÂÄº');
                }
            }

            updateSummary() {
                const summaryDiv = document.getElementById('dataSummary');
                const actionsDiv = document.getElementById('tableActionsSection');
                
                // Always show table actions section (export/import should always be available)
                actionsDiv.style.display = 'block';
                
                if (this.dataItems.length === 0) {
                    summaryDiv.style.display = 'none';
                    return;
                }

                const totalItems = this.dataItems.length;
                const totalSum = this.dataItems.reduce((sum, item) => sum + item.currentValue, 0);
                const averageValue = totalSum / totalItems;

                document.getElementById('totalItems').textContent = totalItems;
                document.getElementById('totalSum').textContent = totalSum.toFixed(2);
                document.getElementById('averageValue').textContent = averageValue.toFixed(2);
                
                // Keep summary hidden by default - only show through button
                // summaryDiv.style.display = 'block';
            }

            toggleSummary() {
                const summaryDiv = document.getElementById('dataSummary');
                
                if (this.dataItems.length === 0) {
                    alert('ÂΩìÂâçÊï∞ÊçÆË°®‰∏≠Ê≤°ÊúâÊï∞ÊçÆÈ°π');
                    return;
                }
                
                // Toggle visibility
                if (summaryDiv.style.display === 'none' || summaryDiv.style.display === '') {
                    summaryDiv.style.display = 'block';
                } else {
                    summaryDiv.style.display = 'none';
                }
            }

            showSuccessMessage(message) {
                const messageEl = document.getElementById('successMessage');
                messageEl.textContent = message;
                messageEl.style.display = 'block';
                
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 3000);
            }

            async exportData() {
                try {
                    // Show loading message
                    this.showSuccessMessage('Ê≠£Âú®ÂáÜÂ§áÂØºÂá∫Êï∞ÊçÆ...');
                    
                    // Collect all data from all tables
                    const exportData = {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        tables: [],
                        totalTables: this.dataTables.length,
                        totalItems: 0
                    };

                    // Export all tables and their data
                    for (const table of this.dataTables) {
                        const tableData = await dataManagerStore.getItem(`dataItems_${table.id}`) || [];
                        exportData.tables.push({
                            ...table,
                            dataItems: tableData
                        });
                        exportData.totalItems += tableData.length;
                    }

                    // Create JSON string
                    const jsonString = JSON.stringify(exportData, null, 2);
                    const fileName = `Êï∞ÊçÆÁÆ°ÁêÜÂô®Â§á‰ªΩ_${new Date().toISOString().split('T')[0]}.json`;
                    
                    // Try multiple download methods for mobile compatibility
                    const downloadSuccess = await this.tryMultipleDownloadMethods(jsonString, fileName);
                    
                    if (downloadSuccess) {
                        this.showSuccessMessage(`ÊàêÂäüÂØºÂá∫ ${exportData.totalTables} ‰∏™Êï∞ÊçÆË°®ÔºåÂÖ± ${exportData.totalItems} ‰∏™Êï∞ÊçÆÈ°πÔºÅ`);
                    } else {
                        // Fallback: Show data in a modal for manual copy
                        this.showExportFallback(jsonString, fileName);
                    }
                } catch (error) {
                    console.error('Error exporting data:', error);
                    alert('ÂØºÂá∫Êï∞ÊçÆÂ§±Ë¥•Ôºö' + error.message);
                }
            }
            
            async tryMultipleDownloadMethods(jsonString, fileName) {
                // Show user-friendly progress message
                this.showSuccessMessage('Â∞ùËØï‰∏ãËΩΩÊñá‰ª∂...');
                
                // Method 1: Standard download with enhanced mobile support
                try {
                    if (await this.tryStandardDownload(jsonString, fileName)) {
                        return true;
                    }
                } catch (error) {
                    console.log('Standard download failed:', error);
                }
                
                // Method 2: Navigator share API (mobile browsers)
                this.showSuccessMessage('Â∞ùËØï‰ΩøÁî®ÂàÜ‰∫´ÂäüËÉΩ...');
                try {
                    if (await this.tryShareAPI(jsonString, fileName)) {
                        return true;
                    }
                } catch (error) {
                    console.log('Share API failed:', error);
                }
                
                // Method 3: Copy to clipboard as fallback
                this.showSuccessMessage('Â∞ùËØïÂ§çÂà∂Âà∞Ââ™Ë¥¥Êùø...');
                try {
                    if (await this.tryCopyToClipboard(jsonString)) {
                        this.showSuccessMessage('Êï∞ÊçÆÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºåËØ∑Á≤òË¥¥Âà∞ÊñáÊú¨ÁºñËæëÂô®‰∏≠‰øùÂ≠ò‰∏∫JSONÊñá‰ª∂');
                        return true;
                    }
                } catch (error) {
                    console.log('Clipboard failed:', error);
                }
                
                return false;
            }
            
            async tryStandardDownload(jsonString, fileName) {
                return new Promise((resolve) => {
                    try {
                        const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                        
                        // Check if we're on mobile Safari
                        const isMobileSafari = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                        const isAndroid = /Android/.test(navigator.userAgent);
                        
                        if (isMobileSafari) {
                            // For iOS Safari, open in new window/tab
                            const url = URL.createObjectURL(blob);
                            const newWindow = window.open(url, '_blank');
                            
                            if (newWindow) {
                                // Clean up after delay
                                setTimeout(() => {
                                    URL.revokeObjectURL(url);
                                    resolve(true);
                                }, 2000);
                            } else {
                                URL.revokeObjectURL(url);
                                resolve(false);
                            }
                        } else {
                            // For other browsers, use download attribute
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            
                            link.href = url;
                            link.download = fileName;
                            link.style.display = 'none';
                            
                            // For Android browsers, don't use target="_blank"
                            if (!isAndroid) {
                                link.target = '_blank';
                                link.rel = 'noopener noreferrer';
                            }
                            
                            // Add to DOM and trigger download
                            document.body.appendChild(link);
                            
                            // Use user gesture for mobile compatibility
                            const clickEvent = new MouseEvent('click', {
                                view: window,
                                bubbles: true,
                                cancelable: true
                            });
                            
                            link.dispatchEvent(clickEvent);
                            
                            // Clean up
                            setTimeout(() => {
                                if (document.body.contains(link)) {
                                    document.body.removeChild(link);
                                }
                                URL.revokeObjectURL(url);
                                resolve(true);
                            }, 1000);
                        }
                        
                    } catch (error) {
                        console.error('Standard download error:', error);
                        resolve(false);
                    }
                });
            }
            
            async tryShareAPI(jsonString, fileName) {
                // Check if Web Share API is available
                if (!navigator.share) {
                    return false;
                }
                
                try {
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    
                    // Try sharing with file first (if supported)
                    if (navigator.canShare) {
                        const file = new File([blob], fileName, { type: 'application/json' });
                        const shareData = {
                            title: 'Êï∞ÊçÆÁÆ°ÁêÜÂô®Â§á‰ªΩ',
                            text: 'Êï∞ÊçÆÁÆ°ÁêÜÂô®ÂØºÂá∫ÁöÑÂ§á‰ªΩÊñá‰ª∂',
                            files: [file]
                        };
                        
                        if (navigator.canShare(shareData)) {
                            await navigator.share(shareData);
                            return true;
                        }
                    }
                    
                    // Fallback: share as text with instructions
                    await navigator.share({
                        title: 'Êï∞ÊçÆÁÆ°ÁêÜÂô®Â§á‰ªΩ',
                        text: `Êï∞ÊçÆÁÆ°ÁêÜÂô®Â§á‰ªΩÊï∞ÊçÆÔºö\n\n${jsonString}\n\nËØ∑Â∞ÜÊ≠§ÂÜÖÂÆπ‰øùÂ≠ò‰∏∫ ${fileName} Êñá‰ª∂`
                    });
                    
                    return true;
                    
                } catch (error) {
                    console.error('Share API error:', error);
                    // If user cancels sharing, don't treat as error
                    if (error.name === 'AbortError') {
                        return true; // User cancelled, but API worked
                    }
                    return false;
                }
            }
            
            async tryCopyToClipboard(jsonString) {
                if (navigator.clipboard && window.isSecureContext) {
                    try {
                        await navigator.clipboard.writeText(jsonString);
                        return true;
                    } catch (error) {
                        console.error('Clipboard API error:', error);
                    }
                }
                
                // Fallback: legacy clipboard method
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = jsonString;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    return successful;
                } catch (error) {
                    console.error('Legacy clipboard error:', error);
                    return false;
                }
            }
            
            showExportFallback(jsonString, fileName) {
                // Create modal for manual copy
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0,0,0,0.8);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                    box-sizing: border-box;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    border-radius: 10px;
                    padding: 20px;
                    max-width: 90vw;
                    max-height: 80vh;
                    overflow: auto;
                    position: relative;
                    -webkit-overflow-scrolling: touch;
                `;
                
                content.innerHTML = `
                    <h3 style="margin-bottom: 15px; color: #333;">ÂØºÂá∫Êï∞ÊçÆ - ÊâãÂä®‰øùÂ≠ò</h3>
                    <p style="margin-bottom: 15px; color: #666; font-size: 14px; line-height: 1.5;">
                        Áî±‰∫éÊµèËßàÂô®ÈôêÂà∂ÔºåËØ∑ÊâãÂä®Â§çÂà∂‰ª•‰∏ãÊï∞ÊçÆÂπ∂‰øùÂ≠ò‰∏∫ <strong>${fileName}</strong><br>
                        <small style="color: #999;">ÊèêÁ§∫ÔºöÁÇπÂáª‰∏ãÊñπÊåâÈíÆÂ§çÂà∂ÔºåÁÑ∂ÂêéÂú®Êñá‰ª∂ÁÆ°ÁêÜÂô®‰∏≠Êñ∞Âª∫ÊñáÊú¨Êñá‰ª∂Âπ∂Á≤òË¥¥</small>
                    </p>
                    <div style="position: relative; margin-bottom: 15px;">
                        <textarea 
                            id="exportDataText" 
                            style="width: 100%; height: 200px; font-family: monospace; font-size: 11px; border: 1px solid #ddd; border-radius: 5px; padding: 10px; resize: vertical; -webkit-appearance: none;"
                            readonly
                        >${jsonString}</textarea>
                        <button 
                            id="selectAllBtn" 
                            style="position: absolute; top: 5px; right: 5px; background: rgba(102, 126, 234, 0.1); color: #667eea; border: 1px solid #667eea; padding: 5px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;"
                        >ÂÖ®ÈÄâ</button>
                    </div>
                    <div style="text-align: center; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button id="copyDataBtn" style="background: #667eea; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 100px;">Â§çÂà∂Êï∞ÊçÆ</button>
                        <button id="downloadTxtBtn" style="background: #4CAF50; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 100px;">‰∏ãËΩΩ‰∏∫TXT</button>
                        <button id="closeModalBtn" style="background: #666; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 80px;">ÂÖ≥Èó≠</button>
                    </div>
                `;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Add event listeners
                document.getElementById('selectAllBtn').addEventListener('click', () => {
                    const textArea = document.getElementById('exportDataText');
                    textArea.focus();
                    textArea.select();
                    textArea.setSelectionRange(0, textArea.value.length);
                });
                
                document.getElementById('copyDataBtn').addEventListener('click', async () => {
                    try {
                        const textArea = document.getElementById('exportDataText');
                        textArea.focus();
                        textArea.select();
                        textArea.setSelectionRange(0, textArea.value.length);
                        
                        if (navigator.clipboard && window.isSecureContext) {
                            await navigator.clipboard.writeText(jsonString);
                        } else {
                            document.execCommand('copy');
                        }
                        
                        this.showSuccessMessage('Êï∞ÊçÆÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ');
                        
                        // Show additional instruction for mobile
                        if (/Mobi|Android/i.test(navigator.userAgent)) {
                            setTimeout(() => {
                                alert('ËØ∑ÊâìÂºÄÊñá‰ª∂ÁÆ°ÁêÜÂô®ÊàñËÆ∞‰∫ãÊú¨Â∫îÁî®ÔºåÊñ∞Âª∫ÊñáÊú¨Êñá‰ª∂Âπ∂Á≤òË¥¥ÂÜÖÂÆπÔºå‰øùÂ≠ò‰∏∫ .json Êñá‰ª∂');
                            }, 500);
                        }
                    } catch (error) {
                        alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®ÈÄâÊã©Âπ∂Â§çÂà∂ÊñáÊú¨');
                        console.error('Copy failed:', error);
                    }
                });
                
                document.getElementById('downloadTxtBtn').addEventListener('click', () => {
                    try {
                        // Try downloading as TXT file
                        const txtBlob = new Blob([jsonString], { type: 'text/plain;charset=utf-8' });
                        const txtUrl = URL.createObjectURL(txtBlob);
                        const txtLink = document.createElement('a');
                        txtLink.href = txtUrl;
                        txtLink.download = fileName.replace('.json', '.txt');
                        txtLink.style.display = 'none';
                        
                        document.body.appendChild(txtLink);
                        txtLink.click();
                        
                        setTimeout(() => {
                            document.body.removeChild(txtLink);
                            URL.revokeObjectURL(txtUrl);
                        }, 1000);
                        
                        this.showSuccessMessage('Â∑≤Â∞ùËØï‰∏ãËΩΩ‰∏∫TXTÊñá‰ª∂ÔºåËØ∑Ê£ÄÊü•‰∏ãËΩΩÊñá‰ª∂Â§π');
                    } catch (error) {
                        alert('TXT‰∏ãËΩΩÂ§±Ë¥•ÔºåËØ∑‰ΩøÁî®Â§çÂà∂ÂäüËÉΩ');
                        console.error('TXT download failed:', error);
                    }
                });
                
                document.getElementById('closeModalBtn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
                
                // Auto-select text on mobile for easier copying
                setTimeout(() => {
                    if (/Mobi|Android/i.test(navigator.userAgent)) {
                        const textArea = document.getElementById('exportDataText');
                        textArea.focus();
                    }
                }, 500);
            }

            importData() {
                // Create file input element
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.style.display = 'none';
                
                input.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    try {
                        const text = await file.text();
                        const importData = JSON.parse(text);
                        
                        // Validate import data structure
                        if (!importData.tables || !Array.isArray(importData.tables)) {
                            throw new Error('Êó†ÊïàÁöÑÊï∞ÊçÆÊ†ºÂºè');
                        }

                        const confirmMessage = `Á°ÆÂÆöË¶ÅÂØºÂÖ•Êï∞ÊçÆÂêóÔºü\n\nÂ∞ÜÂØºÂÖ•Ôºö\n- ${importData.tables.length} ‰∏™Êï∞ÊçÆË°®\n- ÂÖ± ${importData.totalItems || 0} ‰∏™Êï∞ÊçÆÈ°π\n\nÊ≥®ÊÑèÔºö\n- ÂêåÂêçÊï∞ÊçÆË°®Â∞ÜË¢´Ë¶ÜÁõñ\n- Âª∫ËÆÆÂÖàÂ§á‰ªΩÂΩìÂâçÊï∞ÊçÆ\n\nÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ`;
                        
                        if (!confirm(confirmMessage)) {
                            return;
                        }

                        let importedTables = 0;
                        let importedItems = 0;

                        for (const tableData of importData.tables) {
                            // Check if table already exists
                            const existingTableIndex = this.dataTables.findIndex(t => t.name === tableData.name);
                            
                            let tableId;
                            if (existingTableIndex >= 0) {
                                // Update existing table
                                tableId = this.dataTables[existingTableIndex].id;
                                this.dataTables[existingTableIndex] = {
                                    ...tableData,
                                    id: tableId // Keep original ID
                                };
                            } else {
                                // Create new table
                                tableId = this.generateId();
                                this.dataTables.push({
                                    ...tableData,
                                    id: tableId
                                });
                            }

                            // Save table data
                            await dataManagerStore.setItem(`dataItems_${tableId}`, tableData.dataItems || []);
                            importedTables++;
                            importedItems += (tableData.dataItems || []).length;
                        }

                        // Save updated tables list
                        await this.saveTables();
                        
                        // Update UI
                        await this.updateAllTableItemCounts();
                        this.renderTableSelector();
                        this.applyTableFiltersAndSort();
                        await this.loadData();

                        this.showSuccessMessage(`ÊàêÂäüÂØºÂÖ• ${importedTables} ‰∏™Êï∞ÊçÆË°®ÔºåÂÖ± ${importedItems} ‰∏™Êï∞ÊçÆÈ°πÔºÅ`);
                    } catch (error) {
                        console.error('Error importing data:', error);
                        alert('ÂØºÂÖ•Êï∞ÊçÆÂ§±Ë¥•Ôºö' + error.message);
                    }
                });

                // Trigger file selection
                document.body.appendChild(input);
                input.click();
                document.body.removeChild(input);
            }

            // Selective Export Methods
            showSelectiveExport() {
                // Populate table selection list
                this.renderTableSelectionList();
                
                // Show modal
                document.getElementById('selectiveExportModal').classList.add('open');
            }

            renderTableSelectionList() {
                const container = document.getElementById('tableSelectionList');
                
                if (this.dataTables.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ÊöÇÊó†Êï∞ÊçÆË°®</div>';
                    return;
                }

                container.innerHTML = this.dataTables.map(table => {
                    const itemCount = table.itemCount || 0;
                    return `
                        <div class="table-selection-item">
                            <input type="checkbox" id="table_${table.id}" value="${table.id}" checked>
                            <label for="table_${table.id}" class="table-selection-label">
                                ${table.name}
                                ${table.description ? `<br><small style="color: #888;">${table.description}</small>` : ''}
                            </label>
                            <span class="table-selection-info">${itemCount} È°π</span>
                        </div>
                    `;
                }).join('');
            }

            async exportSelectedTables() {
                try {
                    // Get selected table IDs
                    const selectedCheckboxes = document.querySelectorAll('#tableSelectionList input[type="checkbox"]:checked');
                    const selectedTableIds = Array.from(selectedCheckboxes).map(cb => cb.value);
                    
                    if (selectedTableIds.length === 0) {
                        alert('ËØ∑ÈÄâÊã©Ëá≥Â∞ë‰∏Ä‰∏™Êï∞ÊçÆË°®ËøõË°åÂØºÂá∫');
                        return;
                    }
                    
                    // Show loading message
                    this.showSuccessMessage('Ê≠£Âú®ÂáÜÂ§áÂØºÂá∫ÈÄâ‰∏≠ÁöÑÊï∞ÊçÆË°®...');
                    
                    // Collect selected table data
                    const selectedTables = this.dataTables.filter(table => selectedTableIds.includes(table.id));
                    const exportData = {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        tables: [],
                        totalTables: selectedTables.length,
                        totalItems: 0
                    };

                    // Export selected tables and their data
                    for (const table of selectedTables) {
                        const tableData = await dataManagerStore.getItem(`dataItems_${table.id}`) || [];
                        exportData.tables.push({
                            ...table,
                            dataItems: tableData
                        });
                        exportData.totalItems += tableData.length;
                    }

                    // Create JSON string
                    const jsonString = JSON.stringify(exportData, null, 2);
                    const fileName = `Êï∞ÊçÆÁÆ°ÁêÜÂô®ÈÄâÊã©ÂØºÂá∫_${new Date().toISOString().split('T')[0]}.json`;
                    
                    // Try multiple download methods for mobile compatibility
                    const downloadSuccess = await this.tryMultipleDownloadMethods(jsonString, fileName);
                    
                    if (downloadSuccess) {
                        this.showSuccessMessage(`ÊàêÂäüÂØºÂá∫ ${exportData.totalTables} ‰∏™Êï∞ÊçÆË°®ÔºåÂÖ± ${exportData.totalItems} ‰∏™Êï∞ÊçÆÈ°πÔºÅ`);
                        // Close modal
                        this.closeSelectiveExport();
                    } else {
                        // Fallback: Show data in a modal for manual copy
                        this.showExportFallback(jsonString, fileName);
                        // Close selective export modal
                        this.closeSelectiveExport();
                    }
                } catch (error) {
                    console.error('Error exporting selected tables:', error);
                    alert('ÂØºÂá∫ÈÄâ‰∏≠Êï∞ÊçÆË°®Â§±Ë¥•Ôºö' + error.message);
                }
            }

            closeSelectiveExport() {
                document.getElementById('selectiveExportModal').classList.remove('open');
            }

            // Modified import method with name conflict handling
            async importData() {
                // Create file input element
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.style.display = 'none';
                
                input.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    try {
                        const text = await file.text();
                        const importData = JSON.parse(text);
                        
                        // Validate import data structure
                        if (!importData.tables || !Array.isArray(importData.tables)) {
                            throw new Error('Êó†ÊïàÁöÑÊï∞ÊçÆÊ†ºÂºè');
                        }

                        const confirmMessage = `Á°ÆÂÆöË¶ÅÂØºÂÖ•Êï∞ÊçÆÂêóÔºü\n\nÂ∞ÜÂØºÂÖ•Ôºö\n- ${importData.tables.length} ‰∏™Êï∞ÊçÆË°®\n- ÂÖ± ${importData.totalItems || 0} ‰∏™Êï∞ÊçÆÈ°π\n\nÊ≥®ÊÑèÔºö\n- ÂêåÂêçÊï∞ÊçÆË°®Â∞Ü‰øùÁïôÂéüË°®ÔºåÂØºÂÖ•Ë°®‰ºöÊ∑ªÂä†"_bak"ÂêéÁºÄ\n- Âª∫ËÆÆÂÖàÂ§á‰ªΩÂΩìÂâçÊï∞ÊçÆ\n\nÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ`;
                        
                        if (!confirm(confirmMessage)) {
                            return;
                        }

                        let importedTables = 0;
                        let importedItems = 0;
                        let renamedTables = [];

                        for (const tableData of importData.tables) {
                            let tableName = tableData.name;
                            let finalTableId = tableData.id;
                            
                            // Check if table name already exists
                            const existingTable = this.dataTables.find(t => t.name === tableName);
                            if (existingTable) {
                                // Add _bak suffix to imported table name
                                tableName = tableName + '_bak';
                                
                                // Generate new ID for the imported table
                                finalTableId = 'table_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                                
                                renamedTables.push(`"${tableData.name}" ‚Üí "${tableName}"`);
                            }
                            
                            // Create new table entry
                            const newTable = {
                                id: finalTableId,
                                name: tableName,
                                description: tableData.description || '',
                                createdAt: new Date().toISOString(),
                                itemCount: (tableData.dataItems || []).length
                            };
                            
                            // Add to tables list
                            this.dataTables.push(newTable);
                            
                            // Save table data
                            await dataManagerStore.setItem(`dataItems_${finalTableId}`, tableData.dataItems || []);
                            importedTables++;
                            importedItems += (tableData.dataItems || []).length;
                        }

                        // Save updated tables list
                        await this.saveTables();
                        
                        // Update UI
                        await this.updateAllTableItemCounts();
                        this.renderTableSelector();
                        this.applyTableFiltersAndSort();
                        await this.loadData();

                        let successMessage = `ÊàêÂäüÂØºÂÖ• ${importedTables} ‰∏™Êï∞ÊçÆË°®ÔºåÂÖ± ${importedItems} ‰∏™Êï∞ÊçÆÈ°πÔºÅ`;
                        if (renamedTables.length > 0) {
                            successMessage += `\n\nÈáçÂëΩÂêçÁöÑË°®Ôºö\n${renamedTables.join('\n')}`;
                        }
                        
                        this.showSuccessMessage(`ÊàêÂäüÂØºÂÖ• ${importedTables} ‰∏™Êï∞ÊçÆË°®ÔºåÂÖ± ${importedItems} ‰∏™Êï∞ÊçÆÈ°πÔºÅ`);
                        
                        if (renamedTables.length > 0) {
                            setTimeout(() => {
                                alert(`ÈÉ®ÂàÜË°®Âõ†ÂêåÂêçÂÜ≤Á™ÅÂ∑≤ÈáçÂëΩÂêçÔºö\n\n${renamedTables.join('\n')}`);
                            }, 1000);
                        }
                    } catch (error) {
                        console.error('Error importing data:', error);
                        alert('ÂØºÂÖ•Êï∞ÊçÆÂ§±Ë¥•Ôºö' + error.message);
                    }
                });

                // Trigger file selection
                document.body.appendChild(input);
                input.click();
                document.body.removeChild(input);
            }

            // Global export all tables (alias for exportData)
            exportAllTables() {
                this.exportData();
            }

            // Global import all tables (alias for importData)
            importAllTables() {
                this.importData();
            }
        }

        // Initialize data manager
        const dataManager = new DataManager();

        // Auto-fill description with current time when creating new table
        function autoFillCreateTime() {
            const descriptionField = document.getElementById('tableDescription');
            if (descriptionField && !descriptionField.value.trim()) {
                const now = new Date();
                const timeString = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                descriptionField.value = `ÂàõÂª∫‰∫é ${timeString}`;
            }
        }

        // Auto-fill description with current time when copying table
        function autoFillCopyTime() {
            const descriptionField = document.getElementById('copyTableDescription');
            if (descriptionField && !descriptionField.value.trim()) {
                const now = new Date();
                const timeString = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                descriptionField.value = `ÂàõÂª∫‰∫é ${timeString}`;
            }
        }

        // Form tab switching
        function switchFormTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.form-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show/hide form sections
            const createSection = document.querySelector('.table-form-section');
            const copySection = document.querySelector('.copy-form-section');
            
            if (tabName === 'create') {
                createSection.style.display = 'block';
                copySection.classList.remove('active');
                // Auto-fill description when switching to create tab
                setTimeout(() => autoFillCreateTime(), 100);
            } else if (tabName === 'copy') {
                createSection.style.display = 'none';
                copySection.classList.add('active');
                dataManager.updateCopySourceOptions();
                // Auto-fill description when switching to copy tab
                setTimeout(() => autoFillCopyTime(), 100);
            }
        }

        // Table sidebar functions
        function openTableSidebar() {
            document.getElementById('tableSidebar').classList.add('open');
            document.getElementById('tableOverlay').classList.add('open');
            setTimeout(() => {
                document.getElementById('tableName').focus();
                // Auto-fill description when opening sidebar
                autoFillCreateTime();
            }, 300);
        }

        function closeTableSidebar() {
            document.getElementById('tableSidebar').classList.remove('open');
            document.getElementById('tableOverlay').classList.remove('open');
        }

        // Sidebar functions
        function openSidebar() {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('overlay').classList.add('open');
            // Focus on first input for better UX
            setTimeout(() => {
                document.getElementById('dataName').focus();
            }, 300);
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay').classList.remove('open');
        }

        // Copy table form submission
        document.getElementById('copyTableForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const sourceTableId = document.getElementById('sourceTable').value;
            const newName = document.getElementById('copyTableName').value.trim();
            const newDescription = document.getElementById('copyTableDescription').value.trim();
            const resetValues = document.querySelector('input[name="copyOption"]:checked').value === 'reset';
            
            if (sourceTableId && newName) {
                const newTableId = await dataManager.copyTable(sourceTableId, newName, newDescription, resetValues);
                
                if (newTableId) {
                    // Reset form
                    this.reset();
                    
                    // Switch to new table
                    await dataManager.switchTable(newTableId);
                    
                    // Close sidebar
                    closeTableSidebar();
                }
            } else {
                alert('ËØ∑ÈÄâÊã©Ê∫êÊï∞ÊçÆË°®Âπ∂ËæìÂÖ•Êñ∞ÁöÑÊï∞ÊçÆË°®ÂêçÁß∞');
            }
        });

        // Update copy preview when source table or option changes
        document.getElementById('sourceTable').addEventListener('change', () => {
            dataManager.updateCopyPreview();
        });
        
        document.querySelectorAll('input[name="copyOption"]').forEach(radio => {
            radio.addEventListener('change', () => {
                dataManager.updateCopyPreview();
            });
        });

        // Table form submission
        document.getElementById('tableForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('tableName').value.trim();
            const description = document.getElementById('tableDescription').value.trim();
            
            if (name) {
                const tableId = dataManager.createTable(name, description);
                
                // Reset form
                this.reset();
                
                // Switch to new table
                dataManager.switchTable(tableId);
            } else {
                alert('ËØ∑ËæìÂÖ•Êï∞ÊçÆË°®ÂêçÁß∞');
            }
        });

        // Data form submission
        document.getElementById('dataForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('dataName').value.trim();
            const initialValue = document.getElementById('initialValue').value;
            const description = document.getElementById('dataDescription').value.trim();
            
            if (name && initialValue !== '' && !isNaN(parseFloat(initialValue))) {
                dataManager.createDataItem(name, initialValue, description);
                
                // Reset form and close sidebar
                this.reset();
                closeSidebar();
            } else {
                alert('ËØ∑Â°´ÂÜôÂøÖÂ°´Â≠óÊÆµÂπ∂Á°Æ‰øùÂàùÂßãÂÄº‰∏∫ÊúâÊïàÊï∞Â≠ó');
            }
        });

        // Prevent zoom on input focus (iOS Safari)
        document.addEventListener('touchstart', function() {}, {passive: true});
        
        // Immersive Mode functionality
        let isImmersiveMode = localStorage.getItem('immersiveMode') === 'true';
        
        function toggleImmersiveMode() {
            isImmersiveMode = !isImmersiveMode;
            localStorage.setItem('immersiveMode', isImmersiveMode.toString());
            applyImmersiveMode();
        }
        
        function applyImmersiveMode() {
            const body = document.body;
            const button = document.querySelector('.immersive-btn');
            
            if (isImmersiveMode) {
                body.classList.add('immersive-mode');
                if (button) button.classList.add('active');
                
                // Request fullscreen on supported devices
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen().catch(() => {});
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen().catch(() => {});
                }
                
                // Hide address bar on mobile
                setTimeout(() => {
                    window.scrollTo(0, 1);
                }, 100);
                
            } else {
                body.classList.remove('immersive-mode');
                if (button) button.classList.remove('active');
                
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen().catch(() => {});
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen().catch(() => {});
                }
            }
        }
        
        // Apply immersive mode on page load if previously enabled
        document.addEventListener('DOMContentLoaded', () => {
            if (isImmersiveMode) {
                applyImmersiveMode();
            }
        });
        
        // Prevent pull-to-refresh
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
        
        document.addEventListener('touchmove', (e) => {
            // Prevent pull-to-refresh when at top of page
            if (e.touches.length > 1) {
                e.preventDefault();
                return;
            }
            
            const container = document.querySelector('.container');
            if (container && container.scrollTop === 0 && e.touches[0].clientY > e.touches[0].pageY) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Prevent context menu on long press
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
        
        // Hide URL bar on mobile after interaction
        document.addEventListener('touchend', () => {
            if (isImmersiveMode && window.innerHeight < screen.height) {
                setTimeout(() => {
                    window.scrollTo(0, 1);
                }, 500);
            }
        });
        
        // History modal functions
        function closeHistory(event) {
            // Close only if clicking on overlay or close button
            if (!event || event.target.id === 'historyModal' || event.target.classList.contains('history-close')) {
                document.getElementById('historyModal').classList.remove('open');
            }
        }
        
        // Chart functions
        function closeChart(event) {
            // Close only if clicking on overlay or close button
            if (!event || event.target.id === 'chartModal' || event.target.classList.contains('chart-close')) {
                document.getElementById('chartModal').classList.remove('open');
            }
        }

        // Selective Export Modal functions
        function closeSelectiveExport(event) {
            // Close only if clicking on overlay or close button
            if (!event || event.target.id === 'selectiveExportModal' || event.target.classList.contains('history-close')) {
                document.getElementById('selectiveExportModal').classList.remove('open');
            }
        }

        function selectAllTables() {
            const checkboxes = document.querySelectorAll('#tableSelectionList input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        function deselectAllTables() {
            const checkboxes = document.querySelectorAll('#tableSelectionList input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function exportSelectedTables() {
            dataManager.exportSelectedTables();
        }

        // Chart sort event listener
        document.getElementById('chartSort').addEventListener('change', () => {
            dataManager.renderChartItems();
        });

        // Close sidebar/chart/history on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeSidebar();
                closeTableSidebar();
                closeChart();
                closeHistory();
                closeSelectiveExport();
            }
        });
    </script>
</body>
</html>